
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
<<<<<<< HEAD
  <title>Refactoring towards Celluloid - Poignant Code</title>
  <meta name="author" content="">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content="(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.) “Broken gets fixed but crap &hellip;">
  
=======
  <title>Refactoring - Poignant Code</title>
  <meta name="author" content="Sean Marcia">

  
  <meta name="description" content="(note: this blog post is work in progress, I figure since it was getting excessively long I figured I post what I have.) &#8220;Broken gets fixed but &hellip;">
  

>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
<<<<<<< HEAD
  <link rel="canonical" href="http://poignantcode.com/blog/2014/07/21/refactoring/">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Poignant Code" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="Poignant Code" />
  <meta name="og:title" content="Refactoring towards Celluloid" />
  <meta name="og:description" content="(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.) “Broken gets fixed but crap &hellip;" />
  <meta name="og:url" content="http://poignantcode.com/blog/2014/07/21/refactoring/"/>
  <meta name="url" content="http://poignantcode.com/blog/2014/07/21/refactoring/">
  
  <meta name="subject" content=""/>
  <meta name="category" content=""/>
  
  <meta name="distribution" content="global">
=======
  <link rel="canonical" href="http://Poignantcode.com/blog/2014/07/21/refactoring/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Poignant Code" type="application/atom+xml">
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<<<<<<< HEAD
  
=======
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42412754-1', 'poignantcode.com');
  ga('send', 'pageview');

</script>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1

</head>

<body   >
<<<<<<< HEAD
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="/">Poignant Code</a>
    <ul class="nav">
      <li><a href="/blog/archives">Archives</a></li>
      
    </ul>
    <ul class="nav" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      
    </ul>
      
    <form class="navbar-form" action="https://www.google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:poignantcode.com" />
        <input class="span2" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
      
    
  </div>
</div>
</nav>
  <div class="wrapper_single">
    <div class="container">
      <article class="span8 offset2" role="article">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title">Refactoring Towards Celluloid</h1>
=======
  <header role="banner"><hgroup>
  <h1><a href="/">Poignant Code</a></h1>
  
    <h2>“when you don't create things, you become defined by your tastes rather than ability. your tastes only narrow & exclude people. so create.” ― Why The Lucky Stiff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Poignantcode.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Refactoring</h1>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
    
    
      <p class="meta">
        
<<<<<<< HEAD
  


 - 
        
=======
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1








  


<<<<<<< HEAD
<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<sup>st</sup>, 2014</time> - 
        


=======
<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<span>st</span>, 2014</time>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
        
      </p>
    
  </header>


<<<<<<< HEAD
  <div class="entry-content"><p>(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.)</p>

<h3 id="broken-gets-fixed-but-crap-lasts-forever">“Broken gets fixed but crap lasts forever.”</h3>

<p>We had a request a couple years ago for an automated link checker for all the sites in our system so our users would know when content they are linking to was no longer available. While tasks like this are important everywhere, in the academic setting, where I work, this is extremely important as our researchers and professors academic rankings depends on accurate and reviewable information.</p>

<p>I quickly hacked out a horrible solution that worked, put it into a cron job and then promised myself I’d come back and refactor when I had more time.</p>

<p>We’ve recently began to gamify the back end of our site to encourage user engagement and one of the metrics we’re using is the number of broken links. This required a refactoring of the task and a speeding up of it. This is something that is only run in a cron job once a month so the fact that it took 40 or so minutes wasn’t really an issue. We wanted to be able to speed this up so we could run it multiple times a day or hour if we wanted to.</p>

<!-- more -->

<p>So here’s the (ugly) code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="vi">@emaillist</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@logfile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;bad_link_log.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class="line">  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class="line">  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span>
</span><span class="line">  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class="line">  <span class="k">return</span> <span class="n">url</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">notify_site</span><span class="p">(</span><span class="n">problem_type</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="n">email</span> <span class="o">||=</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span>
</span><span class="line">  <span class="k">if</span> <span class="vi">@emaillist</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">+=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="vi">@logfile</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;There was a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> linking to </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2"> was notified.&quot;</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">original_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original_site</span><span class="p">)</span>
</span><span class="line">  <span class="k">begin</span>
</span><span class="line">    <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;404 error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class="line">  <span class="k">rescue</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;broken link error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">release_the_dogs</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span>
</span><span class="line">  <span class="no">BrokenLinkMailer</span><span class="o">.</span><span class="n">broken_link_notifier</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class="line">  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class="line">  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@logfile</span><span class="o">.</span><span class="n">close</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Starting with the low hanging fruit:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line">  <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class="line">  <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class="line">  <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line">  <span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class="line">      <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I started by creating a scope in resources that checks for a <code>page_id</code> and a <code>url</code>. I also created some aliases for <code>url_link</code> and <code>main_content</code> to in my <code>Article</code> model in order to have parity with the <code>Event</code> and <code>Resource</code> model in order to get some uniformity.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class="line"><span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class="line"><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line"><span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class="line"><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">link_resources</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">                               <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">                               <span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">                                   <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">                                   <span class="n">link</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Was passing too much stuff into <code>find_broken_link</code> so that was decomposed.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1">#method for cleaning up the passed in stuff called inside find_broken_link:</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Nothing here really sped the task up so that was the next part. I next implemented Celluloid and broke this up into three files.</p>

<p>Lots of instance variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#checker.rb</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="n">default_protocol</span><span class="p">:</span>   <span class="s1">&#39;http://&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
</span><span class="line">    <span class="n">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
</span><span class="line">    <span class="n">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="n">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>
</span><span class="line">
</span><span class="line">    <span class="n">link_check_results</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkChecker</span>
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:default_protocol</span><span class="p">,</span> <span class="ss">:output_file</span><span class="p">,</span> <span class="ss">:logger</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@default_protocol</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:default_protocol</span><span class="o">]</span>
</span><span class="line">      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class="line">      <span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class="line">      <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line">      <span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class="line">      <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
</span><span class="line">      <span class="vi">@count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">      <span class="n">check_embedded_links</span>
</span><span class="line">      <span class="n">check_direct_links</span>
</span><span class="line">      <span class="nb">self</span>
</span><span class="line">    <span class="k">ensure</span>
</span><span class="line">      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_direct_links</span>
</span><span class="line">      <span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">          <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_embedded_links</span>
</span><span class="line">      <span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">          <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">          <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">            <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">              <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">            <span class="k">end</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="kp">private</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkCell</span>
</span><span class="line">    <span class="kp">include</span> <span class="no">Celluloid</span>
</span><span class="line">
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:logger</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">(((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">empty?</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class="line">      <span class="k">return</span> <span class="n">url</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</span><span class="line">      <span class="n">site</span> <span class="o">=</span> <span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span>
</span><span class="line">      <span class="k">return</span> <span class="k">if</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="line">      <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span>
</span><span class="line">      <span class="k">begin</span>
</span><span class="line">        <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class="line">        <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;404 error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class="line"><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class="line">      <span class="k">rescue</span>
</span><span class="line">        <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Broken link error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class="line"><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I’m still on the fence on <code>DEFAULTS</code> option has I pass in. I realize it is probably better OO to do it that way and it makes it better for customizing and changing in the future but I fell that right now it is just wasting space.</p>

<p>So after cleaning up all those ugly instance variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#link_checker.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkChecker</span>
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:direct_links</span><span class="p">,</span> <span class="ss">:embedded_links</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:output_file</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="ss">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="ss">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@embedded_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line">      <span class="vi">@direct_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span> <span class="o">+</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
</span><span class="line">      <span class="n">check_embedded_links</span>
</span><span class="line">      <span class="n">check_direct_links</span>
</span><span class="line">      <span class="nb">self</span>
</span><span class="line">    <span class="k">ensure</span>
</span><span class="line">      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_direct_links</span>
</span><span class="line">      <span class="n">direct_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_embedded_links</span>
</span><span class="line">      <span class="n">embedded_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">        <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">        <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">          <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">            <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:originating_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">id</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="c1">###</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>I wanted to start fresh with a new log each time so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="n">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
</span><span class="line">    <span class="n">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
</span><span class="line">    <span class="n">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="n">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>
</span><span class="line">
</span><span class="line">    <span class="n">link_check_results</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>No updates yet on the <code>link_cell.rb</code> file but this has greatly improved the speed of the task. What was a ~35 minute task now runs in about a minute.</p>

<p>More refactorings on this to come…</p>
=======
<div class="entry-content"><p>(note: this blog post is work in progress, I figure since it was getting excessively long I figured I post what I have.)</p>

<h3>&#8220;Broken gets fixed but crap lasts forever.&#8221;</h3>

<p>We had a request a couple years ago for an automated link checker for all the sites in our system so our users would know when content they are linking to was no longer available. While tasks like this are important everywhere, in the academic setting, where I work, this is extremely important as our researchers and professors academic rankings depends on accurate and reviewable information.</p>

<p>I quickly hacked out a horrible solution that worked, put it into a cron job and then promised myself I&#8217;d come back and refactor when I had more time.</p>

<!-- more -->


<p>So here&#8217;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@emaillist</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="vi">@logfile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;bad_link_log.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class='line'>  <span class="n">url</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/gmu.local/</span><span class="p">,</span><span class="s1">&#39;gmu.edu&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class='line'>  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">url</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">notify_site</span><span class="p">(</span><span class="n">problem_type</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class='line'>  <span class="n">email</span> <span class="o">||=</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@emaillist</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">+=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">. &lt;a href=</span><span class="se">\&quot;</span><span class="s2">http://</span><span class="si">#{</span><span class="n">domain</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;edu&quot;</span><span class="p">,</span><span class="s2">&quot;edu/admin&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;Fix it!&lt;/a&gt;&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">. &lt;a href=</span><span class="se">\&quot;</span><span class="s2">http://</span><span class="si">#{</span><span class="n">domain</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;edu&quot;</span><span class="p">,</span><span class="s2">&quot;edu/admin&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&gt;Fix it!&lt;/a&gt;&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="vi">@logfile</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;There was a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> linking to </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2"> was notified.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">original_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class='line'>  <span class="n">original_site</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/gmu.local/</span><span class="p">,</span><span class="s1">&#39;gmu.edu&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original_site</span><span class="p">)</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;404 error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;broken link error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">release_the_dogs</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span>
</span><span class='line'>  <span class="no">BrokenLinkMailer</span><span class="o">.</span><span class="n">broken_link_notifier</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class='line'>    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class='line'>    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class='line'>      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@logfile</span><span class="o">.</span><span class="n">close</span>
</span></code></pre></td></tr></table></div></figure>


<p>Starting with the low hanging fruit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'><span class="o">.</span>
</span><span class='line'>  <span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class='line'>      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class='line'>      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class='line'>        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I started by creating a scope in resources that checks for a <code>page_id</code> and a <code>url</code>. I also created some aliases for <code>url_link</code> and <code>main_content</code> to in my <code>Article</code> model in order to have parity with the <code>Event</code> and <code>Resource</code> model in order to get some uniformity.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class='line'><span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class='line'><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class='line'><span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class='line'><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">link_resources</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">link</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Was passing too much stuff into <code>find_broken_link</code> so that was decomposed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#method for cleaning up the passed in stuff called inside find_broken_link:</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing here really sped the task up so that was the next part. I&#8217;ve wanted to do something with Celluloid for a while so this seemed like a pretty good opportunity.</p>

<p>I broke it up into three files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#checker.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Checker</span>
</span><span class='line'>  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">default_protocol</span><span class="p">:</span>   <span class="s1">&#39;http://&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
</span><span class='line'>    <span class="n">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
</span><span class='line'>    <span class="n">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class='line'>    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">link_check_results</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Checker</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LinkChecker</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:default_protocol</span><span class="p">,</span> <span class="ss">:output_file</span><span class="p">,</span> <span class="ss">:logger</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@default_protocol</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:default_protocol</span><span class="o">]</span>
</span><span class='line'>      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class='line'>      <span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class='line'>      <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class='line'>      <span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class='line'>      <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
</span><span class='line'>      <span class="vi">@count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">check_embedded_links</span>
</span><span class='line'>      <span class="n">check_direct_links</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">check_direct_links</span>
</span><span class='line'>      <span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>          <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">check_embedded_links</span>
</span><span class='line'>      <span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class='line'>        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>          <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class='line'>          <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>            <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>              <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Checker</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LinkCell</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Celluloid</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:logger</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class='line'>      <span class="n">url</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/gmu.local/</span><span class="p">,</span><span class="s1">&#39;gmu.edu&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class='line'>      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">(((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">empty?</span><span class="p">)</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">url</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</span><span class='line'>      <span class="n">site</span> <span class="o">=</span> <span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span>
</span><span class='line'>      <span class="n">site</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/gmu.local/</span><span class="p">,</span><span class="s1">&#39;gmu.edu&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">if</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>        <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;404 error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class='line'><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class='line'>      <span class="k">rescue</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Broken link error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class='line'><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lots more refactoring to come on this&#8230;</p>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
</div>


  <footer>
    <p class="meta">
      
  

<<<<<<< HEAD

=======
<span class="byline author vcard">Posted by <span class="fn">Sean Marcia</span></span>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1

      








  


<<<<<<< HEAD
<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<sup>st</sup>, 2014</time>
=======
<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<span>st</span>, 2014</time>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
      


    </p>
    
      <div class="sharing">
  
<<<<<<< HEAD
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://poignantcode.com/blog/2014/07/21/refactoring/" data-via="" data-counturl="http://poignantcode.com/blog/2014/07/21/refactoring/" >Tweet</a>
=======
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://Poignantcode.com/blog/2014/07/21/refactoring/" data-via="seanmarcia" data-counturl="http://Poignantcode.com/blog/2014/07/21/refactoring/" >Tweet</a>
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
  
  
  
</div>

    
<<<<<<< HEAD
    
    
  </footer>

</div>

        
      </article>
    </div>
  </div>
  <div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/2014/07/21/refactoring/">Refactoring towards Celluloid</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span6">
    

  </div>
  <div class="span3">
    

  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/">Poignant Code</a>
  - Copyright &copy; 2014 - 
</p>
<p class="pull-right">
  
    <span>Designed by <a href="http://blog.hyfather.com" target="_blank">Nikhil
  Mungel</a>. Based on <a href="https://github.com/sevenadrian/foxslide"
  target="_blank">foxslide</a>.</span><br/>
  
  <span>
    Powered by <a href="http://octopress.org/" target="_blank">Octopress</a>.
  </span>
  <span>
    Cover photo
    by <a href="http://www.flickr.com/photos/69912667@N07/6778147487/"
    target="_blank">Carrie Nelson</a>.
  </span>
</p>

  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/javascripts/custom.js" type="text/javascript"></script>

=======
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/03/23/model-objects-caching/" title="Previous Post: Model Objects Caching">&laquo; Model Objects Caching</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section class="about">
  <h1>About the author</h1>
  <p>
    <img src="/images/me.png"/>
    I am a web developer who works at <a href="http://www.gmu.edu" target="_blank">GMU</a> - a university in Fairfax, Virginia.
  </p>
  <p>I love anything Web related, new technologies, all things nerdy, coffee roasting, homebrewing and things dealing with statistics and data.</p>
  <p>I also co-founded and help run the best meetup group around, <a href="http://www.arlingtonruby.org" target="_blank">Arlington Ruby</a>!</p>
  <ul id='social-links'>
    <li class="atom"><a href="http://poignantcode.com/atom.xml" target="_blank" title="Subscribe to RSS"></a></li>
    <li class="github"><a href="http://github.com/seanmarcia" target="_blank" title="Github account"></a></li>
    <li class="twitter"><a href="http://twitter.com/#!/seanmarcia" target="_blank" title="Twitter stream"></a></li>
    <li class="linkedin"><a href="http://goo.gl/jYmTN" target="_blank" title="LinkedIn profile"></a></li>
  </ul>
    
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/21/refactoring/">Refactoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/23/model-objects-caching/">Model Objects Caching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/06/intro-to-devops/">Intro to DevOps</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/28/my-irssi-setup/">My Irssi Setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/14/controller-clean-up/">Controller Clean-up</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/SeanMarcia">@SeanMarcia</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'SeanMarcia',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<a class="twitter-timeline" href="https://twitter.com/seanmarcia" data-widget-id="356478747186176002">Tweets by @seanmarcia</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sean Marcia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress,</a> themed by <a href="mailto:teresa@poignantcode.com">Teresa Finn</a><a href</span>
</p>

</footer>
  
>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<<<<<<< HEAD
=======

>>>>>>> 6515e152b7c4bd75784ada3ab6b3f77da912f2d1
</body>
</html>
