
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Refactoring towards Celluloid - Poignant Code</title>
  <meta name="author" content="">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content="(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.) “Broken gets fixed but crap &hellip;">
  
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://SeanMarcia.github.io/blog/2014/07/21/refactoring/">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Poignant Code" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="Poignant Code" />
  <meta name="og:title" content="Refactoring towards Celluloid" />
  <meta name="og:description" content="(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.) “Broken gets fixed but crap &hellip;" />
  <meta name="og:url" content="http://SeanMarcia.github.io/blog/2014/07/21/refactoring/"/>
  <meta name="url" content="http://SeanMarcia.github.io/blog/2014/07/21/refactoring/">
  
  <meta name="subject" content=""/>
  <meta name="category" content=""/>
  
  <meta name="distribution" content="global">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="/">Poignant Code</a>
    <ul class="nav">
      <li><a href="/blog/archives">Archives</a></li>
      
    </ul>
    <ul class="nav" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      
    </ul>
      
    <form class="navbar-form" action="https://www.google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:SeanMarcia.github.io" />
        <input class="span2" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
      
    
  </div>
</div>
</nav>
  <div class="wrapper_single">
    <div class="container">
      <article class="span8 offset2" role="article">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title">Refactoring Towards Celluloid</h1>
    
    
      <p class="meta">
        
  


 - 
        








  


<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<sup>st</sup>, 2014</time> - 
        


        
      </p>
    
  </header>


  <div class="entry-content"><p>(note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.)</p>

<h3 id="broken-gets-fixed-but-crap-lasts-forever">“Broken gets fixed but crap lasts forever.”</h3>

<p>We had a request a couple years ago for an automated link checker for all the sites in our system so our users would know when content they are linking to was no longer available. While tasks like this are important everywhere, in the academic setting, where I work, this is extremely important as our researchers and professors academic rankings depends on accurate and reviewable information.</p>

<p>I quickly hacked out a horrible solution that worked, put it into a cron job and then promised myself I’d come back and refactor when I had more time.</p>

<p>We’ve recently began to gamify the back end of our site to encourage user engagement and one of the metrics we’re using is the number of broken links. This required a refactoring of the task and a speeding up of it. This is something that is only run in a cron job once a month so the fact that it took 40 or so minutes wasn’t really an issue. We wanted to be able to speed this up so we could run it multiple times a day or hour if we wanted to.</p>

<!-- more -->

<p>So here’s the (ugly) code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="vi">@emaillist</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="vi">@logfile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;bad_link_log.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class="line">  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class="line">  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span>
</span><span class="line">  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class="line">  <span class="k">return</span> <span class="n">url</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">notify_site</span><span class="p">(</span><span class="n">problem_type</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="n">email</span> <span class="o">||=</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span>
</span><span class="line">  <span class="k">if</span> <span class="vi">@emaillist</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">+=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="vi">@logfile</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;There was a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> linking to </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2"> was notified.&quot;</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">original_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original_site</span><span class="p">)</span>
</span><span class="line">  <span class="k">begin</span>
</span><span class="line">    <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;404 error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class="line">  <span class="k">rescue</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;broken link error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">release_the_dogs</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span>
</span><span class="line">  <span class="no">BrokenLinkMailer</span><span class="o">.</span><span class="n">broken_link_notifier</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class="line">  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class="line">  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class="line">  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="vi">@logfile</span><span class="o">.</span><span class="n">close</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Starting with the low hanging fruit:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line">  <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
</span><span class="line">  <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
</span><span class="line">  <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line"><span class="o">.</span>
</span><span class="line">  <span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
</span><span class="line">      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class="line">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
</span><span class="line">      <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I started by creating a scope in resources that checks for a <code>page_id</code> and a <code>url</code>. I also created some aliases for <code>url_link</code> and <code>main_content</code> to in my <code>Article</code> model in order to have parity with the <code>Event</code> and <code>Resource</code> model in order to get some uniformity.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class="line"><span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class="line"><span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line"><span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class="line"><span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">link_resources</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">                               <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">                               <span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">                                   <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">                                   <span class="n">link</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Was passing too much stuff into <code>find_broken_link</code> so that was decomposed.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1">#method for cleaning up the passed in stuff called inside find_broken_link:</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">  <span class="p">{</span>
</span><span class="line">    <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">    <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Nothing here really sped the task up so that was the next part. I next implemented Celluloid and broke this up into three files.</p>

<p>Lots of instance variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#checker.rb</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="n">default_protocol</span><span class="p">:</span>   <span class="s1">&#39;http://&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
</span><span class="line">    <span class="n">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
</span><span class="line">    <span class="n">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="n">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>
</span><span class="line">
</span><span class="line">    <span class="n">link_check_results</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkChecker</span>
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:default_protocol</span><span class="p">,</span> <span class="ss">:output_file</span><span class="p">,</span> <span class="ss">:logger</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@default_protocol</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:default_protocol</span><span class="o">]</span>
</span><span class="line">      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
</span><span class="line">      <span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
</span><span class="line">      <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line">      <span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
</span><span class="line">      <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
</span><span class="line">      <span class="vi">@count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">      <span class="n">check_embedded_links</span>
</span><span class="line">      <span class="n">check_direct_links</span>
</span><span class="line">      <span class="nb">self</span>
</span><span class="line">    <span class="k">ensure</span>
</span><span class="line">      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_direct_links</span>
</span><span class="line">      <span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">          <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_embedded_links</span>
</span><span class="line">      <span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
</span><span class="line">        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">          <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">          <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">            <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">              <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">            <span class="k">end</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="kp">private</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkCell</span>
</span><span class="line">    <span class="kp">include</span> <span class="no">Celluloid</span>
</span><span class="line">
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:logger</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">(((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">empty?</span><span class="p">)</span>
</span><span class="line">      <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class="line">      <span class="k">return</span> <span class="n">url</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</span><span class="line">      <span class="n">site</span> <span class="o">=</span> <span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span>
</span><span class="line">      <span class="k">return</span> <span class="k">if</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
</span><span class="line">      <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span>
</span><span class="line">      <span class="k">begin</span>
</span><span class="line">        <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
</span><span class="line">        <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;404 error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class="line"><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
</span><span class="line">      <span class="k">rescue</span>
</span><span class="line">        <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Broken link error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
</span><span class="line"><span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I’m still on the fence on <code>DEFAULTS</code> option has I pass in. I realize it is probably better OO to do it that way and it makes it better for customizing and changing in the future but I fell that right now it is just wasting space.</p>

<p>So after cleaning up all those ugly instance variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#link_checker.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">LinkChecker</span>
</span><span class="line">    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:direct_links</span><span class="p">,</span> <span class="ss">:embedded_links</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:output_file</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="ss">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="ss">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@embedded_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
</span><span class="line">      <span class="vi">@direct_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span> <span class="o">+</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
</span><span class="line">      <span class="n">check_embedded_links</span>
</span><span class="line">      <span class="n">check_direct_links</span>
</span><span class="line">      <span class="nb">self</span>
</span><span class="line">    <span class="k">ensure</span>
</span><span class="line">      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_direct_links</span>
</span><span class="line">      <span class="n">direct_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">check_embedded_links</span>
</span><span class="line">      <span class="n">embedded_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class="line">        <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
</span><span class="line">        <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
</span><span class="line">          <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">            <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">      <span class="p">{</span>
</span><span class="line">        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">,</span>
</span><span class="line">        <span class="ss">:originating_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">id</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="c1">###</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>I wanted to start fresh with a new log each time so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
</span><span class="line"><span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Checker</span>
</span><span class="line">  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="n">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
</span><span class="line">    <span class="n">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
</span><span class="line">    <span class="n">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="n">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span class="line">    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>
</span><span class="line">
</span><span class="line">    <span class="n">link_check_results</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>No updates yet on the <code>link_cell.rb</code> file but this has greatly improved the speed of the task. What was a ~35 minute task now runs in about a minute.</p>

<p>More refactorings on this to come…</p>
</div>


  <footer>
    <p class="meta">
      
  



      








  


<time datetime="2014-07-21T00:12:00-04:00" pubdate data-updated="true">Jul 21<sup>st</sup>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://SeanMarcia.github.io/blog/2014/07/21/refactoring/" data-via="" data-counturl="http://SeanMarcia.github.io/blog/2014/07/21/refactoring/" >Tweet</a>
  
  
  
</div>

    
    
    
  </footer>

</div>

        
      </article>
    </div>
  </div>
  <div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/2014/07/21/refactoring/">Refactoring towards Celluloid</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span6">
    

  </div>
  <div class="span3">
    

  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/">Poignant Code</a>
  - Copyright &copy; 2014 - 
</p>
<p class="pull-right">
  <span>
    Powered by <a href="http://octopress.org/" target="_blank">Octopress</a>.
  </span>
  <span>
    Cover photo
    by <a href="http://www.flickr.com/photos/69912667@N07/6778147487/"
    target="_blank">Carrie Nelson</a>.
  </span>
</p>

  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/javascripts/custom.js" type="text/javascript"></script>








  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
