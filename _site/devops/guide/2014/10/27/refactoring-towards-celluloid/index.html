<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
  <title>Poignant Code</title>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Refactoring towards Celluloid - Poignant Code</title>
    <meta name="description" content="I am a web developer who works at George Mason University. I love anything Web related, new technologies, all things nerdy, coffee roasting, homebrewing and things dealing with statistics and data. I also co-founded and help run the best meetup group around, Arlington Ruby!
">
    <meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Refactoring towards Celluloid - Poignant Code"><meta property="og:site_name" content="Poignant Code"><meta property="og:description" content="I am a web developer who works at George Mason University. I love anything Web related, new technologies, all things nerdy, coffee roasting, homebrewing and things dealing with statistics and data. I also co-founded and help run the best meetup group around, Arlington Ruby!"><meta property="og:url" content="http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/"><meta property="article:published_time" content="2014-10-27T18:00:55-06:00"><meta property="article:author" content="http://localhost:4000/about">

    

    

    <link rel="alternate" type="application/rss+xml" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    <link rel="prefetch" href="http://localhost:4000">
    <link rel="canonical" href="http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/">
    <link rel="stylesheet"
    href="http://localhost:4000/assets/css/main.css">

    <!-- IE Fixes -->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">a,.post-title a{color:#104E8B}a:hover{border-bottom-color:#104E8B}.sidebar{background-color:#104E8B}.wc-top,.sidebar-toggle:active,#sidebar-checkbox:checked ~ .sidebar-toggle{background-color:#104E8B}.sidebar a:hover,.sidebar .sidebar-nav a{border-bottom-color:#135ba2}.sidebar .sidebar-nav{border-top-color:#135ba2}.sidebar .sidebar-nav a.sidebar-nav-item:hover,.sidebar .sidebar-nav a.sidebar-nav-item:focus{background:#125699}.sidebar .sidebar-nav .sidebar-nav-item.active{background-color:#0e467d}ul.social-media li>a{background-color:#0e467d;border-color:#135ba2;border-bottom-color:#135ba2 !important}ul.social-media li>a:hover{background-color:#a5cdf5}.btn{border-color:#104E8B;background:#104e8b}.btn:hover,.btn:focus{border-color:#0d4174;background:#0d4174}</style>
  </head>
  <body>
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><div class="sidebar" id="sidebar">    <img    src="http://localhost:4000/assets/images/avatars.jpg"    alt="Poignant Code" />    <div class="sidebar-info">      <p>        I am a web developer who works at George Mason University. I love anything Web related, new technologies, all things nerdy, coffee roasting, homebrewing and things dealing with statistics and data. I also co-founded and help run the best meetup group around, Arlington Ruby!      </p>  </div>  <nav class="sidebar-nav">    <a class="sidebar-nav-item"      href="http://localhost:4000/">      Home    </a>                        <a class="sidebar-nav-item "      href="http://localhost:4000/about">      About me    </a>                        <a class="sidebar-nav-item "      href="http://localhost:4000/archive">      Blog Archive    </a>                        <a class="sidebar-nav-item "      href="http://localhost:4000/r4g">      Ruby for Good    </a>                        <a class="sidebar-nav-item "      href="http://localhost:4000/golang">      Golang Resources    </a>        <a class="sidebar-nav-item"      href="http://github.com/seanmarcia"      target="_blank">      GitHub/Download    </a>  </nav>  <div class="sidebar-info small">     <p>     </p>  </div>  <ul class="social-media">        <li>        <a title="seanmarcia on Twitter"            href="https://twitter.com/seanmarcia"            class="twitter wc-img-replace" target="_blank">Twitter</a>    </li>            <li>        <a title="+seanmarcia on Google Plus"            href="https://plus.google.com/+seanmarcia"            class="google wc-img-replace" target="_blank">Google</a>    </li>                <li>        <a title="seanmarcia on Github"            href="https://github.com/seanmarcia"            class="github wc-img-replace" target="_blank">Github</a>    </li>                <li>        <a title="Subscribe via RSS"            href="http://localhost:4000/feed.xml"            class="rss wc-img-replace" target="_blank">            RSS        </a>    </li></ul></div>
    <div class="main-wrapper">
      <div class="header">
        <div class="container">
          <div class="header-title">
            <a href="http://localhost:4000/"
              title="Poignant Code">
              <h1>Poignant Code</h1>
              <h3><small>“when you don’t create things, you become defined by your tastes rather than ability. your tastes only narrow & exclude people. so create. ― Why The Lucky Stiff”</small></h3>
            </a>
          </div>
        </div>
      </div>

      <div class="container content">
          <div class="post">

  

  

  <header class="post-header">
    <h1 class="post-title">Refactoring towards Celluloid</h1>
    <p class="post-meta">
    
      <span class="categories">
      devops and guide
      </span> |
    
    <span class="post-date">
    Oct 27, 2014  
    </span>
    </p>
  </header>

  <article class="post-content">
    <p>note: this blog post is work in progress, I figure since it was getting excessively long I would post what I have.)</p>

<h1 id="broken-gets-fixed-but-crap-lasts-forever">“Broken gets fixed but crap lasts forever.”</h1>

<p>We had a request a couple years ago for an automated link checker for all the sites in our system so our users would know when content they are linking to was no longer available. While tasks like this are important everywhere, in the academic setting, where I work, this is extremely important as our researchers and professors academic rankings depends on accurate and reviewable information.</p>

<p>I quickly hacked out a horrible solution that worked, put it into a cron job and then promised myself I’d come back and refactor when I had more time.</p>

<p>We’ve recently began to gamify the back end of our site to encourage user engagement and one of the metrics we’re using is the number of broken links. This required a refactoring of the task and a speeding up of it. This is something that is only run in a cron job once a month so the fact that it took 40 or so minutes wasn’t really an issue. We wanted to be able to speed this up so we could run it multiple times a day or hour if we wanted to.</p>

<p>So here’s the (ugly) code:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@emaillist</span> <span class="o">=</span> <span class="p">{}</span>
<span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
<span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
<span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
<span class="vi">@logfile</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;bad_link_log.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
  <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span>
  <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">return</span> <span class="n">url</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">notify_site</span><span class="p">(</span><span class="n">problem_type</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
  <span class="n">email</span> <span class="o">||=</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span>
  <span class="k">if</span> <span class="vi">@emaillist</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">+=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
  <span class="k">else</span>
    <span class="vi">@emaillist</span><span class="o">[</span><span class="n">email</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;On </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> the link </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> is returning a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="vi">@logfile</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;There was a </span><span class="si">#{</span><span class="n">problem_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_type</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">page_id</span><span class="si">}</span><span class="s2"> linking to </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> and </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2"> was notified.&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">original_site</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
  <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">original_site</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
    <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;404 error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">notify_site</span><span class="p">(</span><span class="s2">&quot;broken link error&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">original_site</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">page_type</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">release_the_dogs</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span>
  <span class="no">BrokenLinkMailer</span><span class="o">.</span><span class="n">broken_link_notifier</span><span class="p">(</span><span class="n">admin_contact</span><span class="p">,</span> <span class="n">contact_message</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
<span class="k">end</span>

<span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>

<span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="vi">@emaillist</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
  <span class="n">release_the_dogs</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="vi">@emaillist</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>

<span class="vi">@logfile</span><span class="o">.</span><span class="n">close</span></code></pre></div>

<p>Starting with the low hanging fruit:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">all</span>
<span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">all</span>
<span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">all</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="vi">@events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">url?</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="vi">@articles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">url_link?</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">url_link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">main_content</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
    <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="vi">@resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">page_id?</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">url?</span>
      <span class="n">find_broken_link</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>I started by creating a scope in resources that checks for a page_id and a url. I also created some aliases for url_link and main_content to in my Article model in order to have parity with the Event and Resource model in order to get some uniformity.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
<span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
<span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
<span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
<span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">link_resources</span>

<span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                               <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
                               <span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
                                   <span class="n">link</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Was passing too much stuff into find_broken_link so that was decomposed.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
  <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
    <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
      <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">#method for cleaning up the passed in stuff called inside find_broken_link:</span>

<span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
    <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
    <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
    <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre></div>

<p>Nothing here really sped the task up so that was the next part. I next implemented Celluloid and broke this up into three files.</p>

<p>Lots of instance variables:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#checker.rb</span>
<span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>

<span class="k">module</span> <span class="nn">Checker</span>
  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">default_protocol</span><span class="p">:</span>   <span class="s1">&#39;http://&#39;</span><span class="p">,</span>
    <span class="ss">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
    <span class="ss">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
    <span class="ss">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
    <span class="ss">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>

    <span class="n">link_check_results</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Checker</span>
  <span class="k">class</span> <span class="nc">LinkChecker</span>
    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:default_protocol</span><span class="p">,</span> <span class="ss">:output_file</span><span class="p">,</span> <span class="ss">:logger</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
      <span class="vi">@default_protocol</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:default_protocol</span><span class="o">]</span>
      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="ss">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="ss">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span>
      <span class="vi">@event_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span>
      <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
      <span class="vi">@article_links</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span>
      <span class="vi">@resources</span> <span class="o">=</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
      <span class="vi">@count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">check_embedded_links</span>
      <span class="n">check_direct_links</span>
      <span class="nb">self</span>
    <span class="k">ensure</span>
      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">check_direct_links</span>
      <span class="o">[</span><span class="vi">@event_links</span><span class="p">,</span> <span class="vi">@article_links</span><span class="p">,</span> <span class="vi">@resources</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">check_embedded_links</span>
      <span class="o">[</span><span class="vi">@events</span><span class="p">,</span> <span class="vi">@articles</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">collection_item</span><span class="o">|</span>
        <span class="n">collection_item</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
          <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
            <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
              <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Checker</span>
  <span class="k">class</span> <span class="nc">LinkCell</span>
    <span class="kp">include</span> <span class="no">Celluloid</span>

    <span class="kp">attr_reader</span> <span class="ss">:logger</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">logger</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">organize_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span>
      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">originating_site_domain</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\//</span><span class="p">)</span>
      <span class="n">url</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="p">(((</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^http\:\/\//</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^https\:\/\//</span><span class="p">)))</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">empty?</span><span class="p">)</span>
      <span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">regexp</span><span class="o">[</span><span class="ss">:ABS_URI</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">return</span> <span class="n">url</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
      <span class="n">site</span> <span class="o">=</span> <span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">baseurl</span> <span class="o">=</span> <span class="n">organize_url</span><span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="p">,</span><span class="n">site</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">baseurl</span><span class="p">))</span>
        <span class="nb">puts</span> <span class="s2">&quot;Code: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;404 error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
<span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
      <span class="k">rescue</span>
        <span class="nb">puts</span> <span class="s2">&quot;Broken/bad link for </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Broken link error, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:original_site</span><span class="o">]</span><span class="si">}</span><span class="s2">, \</span>
<span class="s2">                  </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:admin_email</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="ss">:page_type</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>I’m still on the fence on DEFAULTS option has I pass in. I realize it is probably better OO to do it that way and it makes it better for customizing and changing in the future but I fell that right now it is just wasting space.</p>

<p>So after cleaning up all those ugly instance variables:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#link_checker.rb</span>
<span class="k">module</span> <span class="nn">Checker</span>
  <span class="k">class</span> <span class="nc">LinkChecker</span>
    <span class="kp">attr_reader</span> <span class="ss">:agent_pool</span><span class="p">,</span> <span class="ss">:direct_links</span><span class="p">,</span> <span class="ss">:embedded_links</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:opts</span><span class="p">,</span> <span class="ss">:output_file</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">override_opts</span><span class="o">=</span><span class="p">{})</span>
      <span class="vi">@opts</span>  <span class="o">=</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">override_opts</span><span class="p">)</span>
      <span class="vi">@output_file</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:output_file</span><span class="o">]</span> <span class="o">||</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">opts</span><span class="o">[</span><span class="ss">:log_file_name</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
      <span class="vi">@logger</span> <span class="o">=</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:logger_class</span><span class="o">].</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
      <span class="vi">@agent_pool</span> <span class="o">=</span> <span class="no">LinkCell</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="ss">size</span><span class="p">:</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:pool_size</span><span class="o">]</span><span class="p">,</span> <span class="ss">args</span><span class="p">:</span> <span class="o">[</span><span class="n">logger</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@embedded_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">unlinked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">unlinked_articles</span>
      <span class="vi">@direct_links</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">linked_events</span> <span class="o">+</span> <span class="no">Article</span><span class="o">.</span><span class="n">linked_articles</span> <span class="o">+</span> <span class="no">Resource</span><span class="o">.</span><span class="n">linkable</span>
      <span class="n">check_embedded_links</span>
      <span class="n">check_direct_links</span>
      <span class="nb">self</span>
    <span class="k">ensure</span>
      <span class="n">output_file</span><span class="o">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">output_file</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:close</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">check_direct_links</span>
      <span class="n">direct_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
        <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">check_embedded_links</span>
      <span class="n">embedded_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
        <span class="n">long_desc_links</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/http/</span><span class="p">}</span>
        <span class="k">unless</span> <span class="n">long_desc_links</span><span class="o">.</span><span class="n">blank?</span>
          <span class="n">long_desc_links</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
            <span class="n">find_broken_link</span><span class="p">(</span><span class="n">link_details</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">link_details</span><span class="p">(</span><span class="n">link_item</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="ss">:original_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
        <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="ss">:admin_email</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span> <span class="p">:</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">reporting_email</span><span class="p">,</span>
        <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">link_item</span><span class="o">.</span><span class="n">url</span> <span class="p">:</span> <span class="n">link</span><span class="p">,</span>
        <span class="ss">:page_type</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">pluralize</span><span class="p">,</span>
        <span class="ss">:originating_site</span> <span class="o">=&gt;</span> <span class="n">link_item</span><span class="o">.</span><span class="n">originating_site</span><span class="o">.</span><span class="n">id</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">find_broken_link</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
      <span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>I wanted to start fresh with a new log each time so:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;celluloid/autostart&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_cell&#39;</span>
<span class="n">require_relative</span> <span class="s1">&#39;broken_link/link_checker&#39;</span>

<span class="k">module</span> <span class="nn">Checker</span>
  <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">pool_size</span><span class="p">:</span>          <span class="mi">25</span><span class="p">,</span>
    <span class="ss">logger_class</span><span class="p">:</span>       <span class="no">Logger</span><span class="p">,</span>
    <span class="ss">admin_email</span><span class="p">:</span>        <span class="s2">&quot;No Admin &lt;chssweb@gmu.edu&gt;&quot;</span><span class="p">,</span>
    <span class="ss">log_file_name</span><span class="p">:</span>      <span class="s2">&quot;bad_link_log.csv&quot;</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">linkcheck</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="s2">&quot;bad_link_log.csv&quot;</span><span class="p">)</span>
    <span class="n">link_check_results</span> <span class="o">=</span> <span class="no">LinkChecker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">link_check_results</span><span class="o">.</span><span class="n">agent_pool</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">terminate</span>

    <span class="n">link_check_results</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>No updates yet on the link_cell.rb file but this has greatly improved the speed of the task. What was a ~35 minute task now runs in about a minute.</p>

<p>More refactorings on this to come…</p>
    
  </article>

  
    <div class="related-posts">
      <h4>Related Posts</h4>
      <ul>
        
          <li>
            <h5>
              <a href="http://localhost:4000/ruby/community/2014/12/14/rubyconf-au/">
                Rubyconf Australia Retrospective
                <small>14 Dec 2014</small>
              </a>
            </h5>
          </li>
        
          <li>
            <h5>
              <a href="http://localhost:4000/ruby/meetups/2014/12/14/arlington-ruby/">
                Reflecting on Arlington Ruby
                <small>14 Dec 2014</small>
              </a>
            </h5>
          </li>
        
          <li>
            <h5>
              <a href="http://localhost:4000/devops/guide/2014/07/10/model-object-caching/">
                Model Object Caching
                <small>10 Jul 2014</small>
              </a>
            </h5>
          </li>
        
      </ul>
    </div>
  

  <div class="author-info">
    
      <div class="author">   <a href="http://localhost:4000/about">    <img       src="http://localhost:4000/assets/images/avatars.jpg"      alt="Poignant Code" width="60" height="60" />  </a>    <h5>Author</h4>  <h6>    <a href="http://localhost:4000/about">      Sean Marcia    </a>  </h5>  <p>    Find me on            <a title="seanmarcia on Twitter"             href="https://twitter.com/seanmarcia"             class="twitter" target="_blank">Twitter</a>                     /        <a title="+seanmarcia on Google Plus"             href="https://plus.google.com/+seanmarcia"             class="google" target="_blank">Google</a>      </p></div>
    
  
    
      <div class="share-buttons">  <h5>Share this post on</h5>  <ul class="social-media">    <li>        <a title="seanmarcia on Twitter"           href="https://twitter.com/intent/tweet?original_referer=http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/&amp;text=Refactoring towards Celluloid&amp;url=http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/" class="twitter wc-img-replace" target="_blank">          Twitter        </a>    </li>       <li>        <a title="+seanmarcia on Google Plus"             href="https://plus.google.com/share?url=http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/"             class="google wc-img-replace" target="_blank">Google</a>    </li>    <li>        <a title=" on Facebook"             href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/devops/guide/2014/10/27/refactoring-towards-celluloid/&amp;t=Refactoring towards Celluloid"             class="facebook wc-img-replace" target="_blank">Facebook</a>    </li>  </ul></div>
      
  </div>
  
  
</div>

      </div>
      <a href="#0" class="wc-top">Top</a>

    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle">
      <span></span>
    </label>

    <script type="text/javascript">
      var config = {
        "browser_warning_page": "http://localhost:4000/browser-warning/",
        "disqus_shortname": ""
      };
      /* Browser support detection */
      var browserSupport = (function(){
        var htmlElemClasses = document.querySelector('html').className.split(' ');
        for ( var i = 0; i < htmlElemClasses.length; i += 1 ){
          var className = htmlElemClasses[i];
          if ( className === 'lt-ie9' ){
            return true;
          }
        }
      }());

      if (browserSupport){
        window.location="http://localhost:4000/browser-warning/";
      }

      /* To avoid render blocking css */
      var cb = function() {
        var l = document.createElement('link'); l.rel = 'stylesheet';
        l.href = 'http://fonts.googleapis.com/css?family=PT+Sans';
        var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
      };
      var raf = requestAnimationFrame || mozRequestAnimationFrame ||
          webkitRequestAnimationFrame || msRequestAnimationFrame;
      if (raf) raf(cb);
      else window.addEventListener('load', cb);


    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script async type="text/javascript" src="http://localhost:4000/assets/js/gaya.min.js"></script>

    
    
  </body>
</html>