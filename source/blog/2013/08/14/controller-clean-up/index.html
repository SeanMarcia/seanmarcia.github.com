
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Controller Clean-up - Poignant Code</title>
  <meta name="author" content="Sean Marcia">

  
  <meta name="description" content="We all have those files that work but are ugly and we don&#8217;t want to refactor. Or as the quote goes Broken code gets fixed but bad code sticks &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Poignantcode.com/blog/2013/08/14/controller-clean-up/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Poignant Code" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42412754-1', 'poignantcode.com');
  ga('send', 'pageview');

</script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Poignant Code</a></h1>
  
    <h2>“when you don't create things, you become defined by your tastes rather than ability. your tastes only narrow & exclude people. so create.” ― Why The Lucky Stiff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Poignantcode.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Controller Clean-up</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-14T14:06:00-04:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>We all have those files that work but are ugly and we don&#8217;t want to refactor. Or as the quote goes <code>Broken code gets fixed but bad code sticks around forever.</code></p>

<p>I had an ugly controller that worked so I was content to leave it and focus on other things. However, when I was going through the codebase and updating all the old <code>find</code> syntax to the newer <code>where</code> syntax and I realized I couldn&#8217;t avoid this controller anymore.</p>

<p>Here is the controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CourseSectionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="c1"># GET /sections</span>
</span><span class='line'>  <span class="c1"># GET /sections.xml</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:find_course</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:distance</span><span class="o">]</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:determine_section</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:index</span>
</span><span class='line'>  <span class="c1"># caches_action :index, :cache_path =&gt; Proc.new { |c| c.params }</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chss&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@selected_term</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">current_term</span> <span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@current_code</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">by_code</span><span class="o">.</span><span class="n">first</span> <span class="p">:</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">find_by_code</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="c1"># throw a 404</span>
</span><span class='line'>      <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@undergraduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@undergraduate_course_levels</span> <span class="o">=</span> <span class="vi">@undergraduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>      <span class="vi">@undergraduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@graduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@graduate_course_levels</span> <span class="o">=</span> <span class="vi">@graduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>      <span class="vi">@graduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:xml</span> <span class="o">=&gt;</span> <span class="vi">@courses</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="c1">#ActiveRecord::RecordNotFound</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;shared/404.html.erb&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /sections/1</span>
</span><span class='line'>  <span class="c1"># GET /sections/1.xml</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@course_section</span> <span class="o">=</span> <span class="no">CourseSection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># show.html.erb</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">xml</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:xml</span> <span class="o">=&gt;</span> <span class="vi">@section</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;shared/404.html.erb&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_course</span>
</span><span class='line'>    <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:course_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">determine_section</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lots going on there, and a lot going on that isn&#8217;t needed. The first task it to convert the finder syntax.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@undergraduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'><span class="vi">@undergraduate_course_levels</span> <span class="o">=</span> <span class="vi">@undergraduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'><span class="vi">@undergraduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@graduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'><span class="vi">@graduate_course_levels</span> <span class="o">=</span> <span class="vi">@graduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'><span class="vi">@graduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reading the code over there is a lot that can be trimmed out. Plus since each of the controller is doing an identical rescue we can compact those into a <code>rescue_from</code> action. After clean up our file is about half the size:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CourseSectionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rescue_from</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="ss">:record_not_found</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:find_course</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chss&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@selected_term</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">current_term</span> <span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@current_code</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">by_code</span><span class="o">.</span><span class="n">first</span> <span class="p">:</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">find_by_code</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="c1"># throw a 404</span>
</span><span class='line'>      <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="vi">@undergraduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@undergraduate_course_levels</span> <span class="o">=</span> <span class="vi">@undergraduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>      <span class="vi">@undergraduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@graduate_courses</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@graduate_course_levels</span> <span class="o">=</span> <span class="vi">@graduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>      <span class="vi">@graduate_special_topics</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@course_section</span> <span class="o">=</span> <span class="no">CourseSection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_course</span>
</span><span class='line'>    <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:course_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">record_not_found</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;shared/404.html.erb&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="mi">404</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a lot of instance variables in there and if we want to break this up or add to it, say with distance courses like hinted at in the first file there is going to be a lot more ugliness. Going by Pivotal&#8217;s rule that a controller shouldn&#8217;t be more than 5 lines it seems like a good opportunity to use the presenter pattern. If you are unfamiliar, <a href="http://devblog.avdi.org/2012/06/04/displaycase-gem-now-available/">Avdi talks here</a> about the presenter pattern and provides some links to it.
Ideally, in the view it would be nice to have something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= @course_sections.undergraduate_courses %&gt;</span>
</span><span class='line'><span class="sx">and</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">undergraduate_special_topics</span> <span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">and</span>
</span><span class='line'><span class="sx">&lt;%= @course_sections.graduate_courses %&gt;</span>
</span><span class='line'><span class="ow">and</span> <span class="n">so</span> <span class="n">on</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>So taking a crack at moving this into a presenter we get:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CourseSectionPresenter</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@selected_term</span> <span class="o">=</span> <span class="n">term</span>
</span><span class='line'>      <span class="vi">@current_code</span> <span class="o">=</span> <span class="n">code</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">undergraduate_courses</span>
</span><span class='line'>      <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">undergraduate_course_levels</span>
</span><span class='line'>      <span class="n">undergraduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">undergraduate_special_topics</span>
</span><span class='line'>      <span class="no">Course</span><span class="o">.</span><span class="n">undergraduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">graduate_courses</span>
</span><span class='line'>      <span class="no">Course</span><span class="o">.</span><span class="n">offered_in</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">)</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">graduate_course_levels</span>
</span><span class='line'>      <span class="n">graduate_courses</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">course_level</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">graduate_special_topics</span>
</span><span class='line'>      <span class="no">Course</span><span class="o">.</span><span class="n">graduate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;course_code_id = ? AND special_topic = ?&quot;</span><span class="p">,</span> <span class="vi">@current_code</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:course_number</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With our new controller (before refactoring our views) currently looking like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CourseSectionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rescue_from</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="ss">:record_not_found</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:find_course</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chss&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@selected_term</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">current_term</span> <span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@current_code</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">by_code</span><span class="o">.</span><span class="n">first</span> <span class="p">:</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">find_by_code</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@course_sections</span> <span class="o">=</span> <span class="no">CourseSectionPresenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@selected_term</span><span class="p">,</span> <span class="vi">@current_code</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@undergraduate_courses</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">undergraduate_courses</span>
</span><span class='line'>    <span class="vi">@undergraduate_course_levels</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">undergraduate_course_levels</span>
</span><span class='line'>    <span class="vi">@undergraduate_special_topics</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">undergraduate_special_topics</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@graduate_courses</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">graduate_courses</span>
</span><span class='line'>    <span class="vi">@graduate_course_levels</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">graduate_course_levels</span>
</span><span class='line'>    <span class="vi">@graduate_special_topics</span> <span class="o">=</span> <span class="vi">@course_sections</span><span class="o">.</span><span class="n">graduate_special_topics</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@course_section</span> <span class="o">=</span> <span class="no">CourseSection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_course</span>
</span><span class='line'>    <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:course_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">record_not_found</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;shared/404.html.erb&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="mi">404</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then after refactoring our views:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CourseSectionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rescue_from</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="ss">:record_not_found</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:find_course</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chss&quot;</span> <span class="k">if</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>    <span class="vi">@selected_term</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">current_term</span> <span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@current_code</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">by_code</span><span class="o">.</span><span class="n">first</span> <span class="p">:</span> <span class="no">CourseCode</span><span class="o">.</span><span class="n">on_site</span><span class="p">(</span><span class="n">current_site</span><span class="p">)</span><span class="o">.</span><span class="n">find_by_code</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@course_sections</span> <span class="o">=</span> <span class="no">CourseSectionPresenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">current_term</span> <span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:term</span><span class="o">]</span><span class="p">,</span> <span class="vi">@current_code</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@course_section</span> <span class="o">=</span> <span class="no">CourseSection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:person</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_course</span>
</span><span class='line'>    <span class="vi">@course</span> <span class="o">=</span> <span class="no">Course</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:course_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">record_not_found</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;shared/404.html.erb&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="mi">404</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can further clean this up by moving the <code>@selected_term</code> and <code>@current_code</code> instance variables into the model but there is a separate controller also currently using them (don&#8217;t ask) so more will need to be done before we can completely clean this up.</p>

<p>Aside from cleaning up our code, this gives us the added benefit of making our code much cleaner and easier to read as well removing the number of instance variables floating around. Plus, and probably most important of all, it makes our code easier to test.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sean Marcia</span></span>

      








  


<time datetime="2013-08-14T14:06:00-04:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://Poignantcode.com/blog/2013/08/14/controller-clean-up/" data-via="seanmarcia" data-counturl="http://Poignantcode.com/blog/2013/08/14/controller-clean-up/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/07/28/why-i-dont-like-send/" title="Previous Post: Why I Don't Like Send">&laquo; Why I Don't Like Send</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/08/28/my-irssi-setup/" title="Next Post: My Irssi Setup">My Irssi Setup &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section class="about">
  <h1>About the author</h1>
  <p>
    <img src="/images/me.png"/>
    I am a web developer who works at <a href="http://www.gmu.edu" target="_blank">GMU</a> - a university in Fairfax, Virginia.
  </p>
  <p>I love anything Web related, new technologies, all things nerdy, coffee roasting, homebrewing and things dealing with statistics and data.</p>
  <p>I also co-founded and help run the best meetup group around, <a href="http://www.arlingtonruby.org" target="_blank">Arlington Ruby</a>!</p>
  <ul id='social-links'>
    <li class="atom"><a href="http://poignantcode.com/atom.xml" target="_blank" title="Subscribe to RSS"></a></li>
    <li class="github"><a href="http://github.com/seanmarcia" target="_blank" title="Github account"></a></li>
    <li class="twitter"><a href="http://twitter.com/#!/seanmarcia" target="_blank" title="Twitter stream"></a></li>
    <li class="linkedin"><a href="http://goo.gl/jYmTN" target="_blank" title="LinkedIn profile"></a></li>
  </ul>
    
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/21/refactoring/">Refactoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/23/model-objects-caching/">Model Objects Caching</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/06/intro-to-devops/">Intro to DevOps</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/28/my-irssi-setup/">My Irssi Setup</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/14/controller-clean-up/">Controller Clean-up</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/SeanMarcia">@SeanMarcia</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'SeanMarcia',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
<a class="twitter-timeline" href="https://twitter.com/seanmarcia" data-widget-id="356478747186176002">Tweets by @seanmarcia</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Sean Marcia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress,</a> themed by <a href="mailto:teresa@poignantcode.com">Teresa Finn</a><a href</span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
